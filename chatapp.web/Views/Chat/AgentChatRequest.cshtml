@model Project1.Models.ViewModel.AgentChatVm

@{
    ViewBag.Title = "Admin Agent - Chat";
}

<h1>Welcome to Admin Chat</h1>

<p>
    You are speaking to <b>@Model.ClientName</b>
</p>

@section extraTopStyles{
    <link href="~/Content/chatpopup.css" rel="stylesheet" type="text/css" />
}

<div class="container">
    <p>
        Please click the item on the bottom right to start chatting to <b>@Model.ClientName</b>.
    </p>

    @Html.Partial("_ChatPopup")
</div>



@section PageScripts{
    <script src="~/scripts/jquery.signalR-2.2.2.min.js"></script>
    <script src="~/signalr/js"></script>
    <script src="~/scripts/site.js"></script>

    <script>
        var useridCookieName = "userid";
        var roomidCookieName = "roomid";

        var clientIdCookieName = "clientId";
        
        $(document).ready(function() {

            $(".left-first-section").click(function() {
                $('.main-section').toggleClass("open-more");
            });

            $(".fa-minus").click(function() {
                $('.main-section').toggleClass("open-more");
            });

            //plant cookies for admin chat.
            setCookie(clientIdCookieName, '@Model.ClientContextId', 1);
            setCookie(roomidCookieName, '@Model.RoomId', 1);

            var userNameExists = DoesCookieExist(useridCookieName);
            console.log('user exists ' + userNameExists);

            //if user exists then let's get details from server to display.
            if (userNameExists) {
                $('.main-section').toggleClass("open-more");
            } else { //just display form for username
                $('#chatSection').hide();
                $('#chatIntro').show();
            }

            //Get proxy instance using the auto-generated proxy class
            var chatProxy = $.connection.chatRoom;

            var logUserToChat = function() {

                try {
                    $.connection.hub.start().done(function() {
                        var username = $('#txtUserName').val();
                        $.connection.chatRoom.server.connectUserToHub(username);
                    });
                } catch (e) {
                    console.log('Error on connecting user: ' + e.message);
                }
            };

            //receive connection details and store them into cookies.
            chatProxy.client.receiveConnectionDetails = function (userId, userRoomId) {
                var username = $('#txtUserName').val();
                setCookie(useridCookieName, userId, 1);
                setCookie(roomidCookieName, userRoomId, 1);
                $('#chatIntro').hide();
                $('#chatSection').show();
                $('#pConnectedTo').html("Welcome " + username + "<br/> We are trying to connect you to an agent...");
                chatProxy.server.connectUserToAgent(userId, username);
            }

            chatProxy.client.handleServerError = function (errorCode, message) {
                alert('An error occured: ' + message);
            }

            $('#btnStartChat').on("click", logUserToChat);

        });
    </script>


}